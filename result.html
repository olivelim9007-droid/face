<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>피부 진단 결과</title>
		<link rel="stylesheet" href="./result-styles.css">
	</head>
	<body class="result-elem-1">
	<div class="result-elem-2">
		<div class="result-elem-3">
			<div class="result-elem-4">
				<div class="result-elem-5"></div>
			</div>
			<!-- 헤더: 브리핑 위에 붙임 -->
			<div class="result-header">
				<div class="result-header-inner">
						<a id="result-back" href="./index.html" class="result-header-back" aria-label="뒤로">
						<img class="result-header-back-icon" src="./img/icon_modal_back.svg" alt="">
					</a>
					<div class="result-header-title">피부 진단</div>
					<button type="button" class="result-header-icon-wrap" id="result-close" aria-label="닫기">
						<img class="result-header-icon" src="./img/result_header_icon.svg" alt="">
					</button>
				</div>
			</div>
			<div class="result-elem-6">
				<div class="result-elem-7">
					<div class="result-elem-8">
						<div class="result-elem-9">
							<div class="result-elem-10">브리핑</div>
						</div>
					</div>
					<div class="result-elem-11 result-header-old is-hidden">
						<a href="./index.html" class="result-elem-12" aria-label="뒤로">
							<div class="result-elem-13">
								<div class="result-elem-14">
									<div class="result-elem-15">&#10094;</div>
								</div>
							</div>
						</a>
						<div class="result-elem-16">피부 진단</div>
						<div class="result-elem-17">
							<img class="result-elem-18" src="./img/result_icons.svg" alt=""></img>
						</div>
					</div>
					<div class="result-briefing-thumb" id="result-briefing-thumb" role="img" aria-label="피부 진단 썸네일"></div>
					<div class="result-elem-20">
						<div class="result-elem-21">
							<div class="result-elem-22">
								<span class="result-elem-23">피부 점수는 </span><span class="result-elem-24" id="skin-score">80</span><span class="result-elem-25">점</span>
							</div>
						</div>
						<div class="result-elem-26" id="result-briefing">컨디션은 좋지만 수분이 금방 빠져나가는 타입으로 보여요. 속부터 채우는 촉촉한 케어가 필요해요.<br/>피부 장벽과 탄력은 안정적이지만 수분 손실 지표가 다소 높습니다.</div>
					</div>
				</div>
				<div class="result-elem-27">
					<div class="result-elem-28">
						<div class="result-elem-29">피부 그래프</div>
					</div>
				</div>
				<div class="result-elem-30">
					<img class="result-elem-31" src="./img/result_lines.svg" alt=""></img>
					<img class="result-elem-32" src="./img/result_path.svg" alt="">
					<div class="result-elem-33">
						<div class="result-elem-34">색소</div>
						<div class="result-elem-35">주름</div>
						<div class="result-elem-36">탄력</div>
						<div class="result-elem-37">탄력</div>
						<div class="result-elem-38">좌우 대칭</div>
						<div class="result-elem-39">수분</div>
					</div>
				</div>
				<div class="result-elem-40">
					<div class="result-elem-41">
						<div class="result-elem-42">루틴</div>
					</div>
					<div class="result-elem-43" id="result-routine-list">
						<div class="result-elem-44">
							<div class="result-elem-45">저자극 클렌징</div>
						</div>
						<div class="result-elem-46">
							<div class="result-elem-47">
								<div class="result-elem-48">
									<div class="result-elem-49">수분 토너 충분히 흡수</div>
								</div>
							</div>
						</div>
						<div class="result-elem-50">
							<div class="result-elem-51">히알루론산/판테놀 에센스</div>
						</div>
						<div class="result-elem-52">
							<div class="result-elem-53">보습크림으로 수분 잠금</div>
						</div>
						<div class="result-elem-54">
							<div class="result-elem-55">자외선 차단</div>
						</div>
					</div>
				</div>
				<div class="result-elem-56">
					<div class="result-elem-57">
						<div class="result-elem-58">
							<div class="result-elem-59">오늘의 추천 스타일</div>
						</div>
						<div class="result-elem-60">
							<div class="result-elem-61">
								<img class="result-elem-62" src="./img/result-elem-62.png" alt="">
								<div class="result-elem-63">
									<div class="result-elem-64">Cheek</div>
									<div class="result-elem-65">톤 대비 결과, 저채도 핑크가 가장 안정적입니다.</div>
								</div>
							</div>
							<div class="result-elem-66">
								<img class="result-elem-67" src="./img/result-elem-67.png" alt="">
								<div class="result-elem-68">
									<div class="result-elem-69">Peach</div>
									<div class="result-elem-70">채도 분석 결과, 저채도 피치가 가장 안정적입니다.</div>
								</div>
							</div>
							<div class="result-elem-71">
								<img class="result-elem-72" src="./img/result-elem-72.png" alt="">
								<div class="result-elem-73">
									<div class="result-elem-74">Cheek</div>
									<div class="result-elem-75">눈동자 브라운 컬러가 자연스럽게 균형을 맞춥니다.</div>
								</div>
							</div>
							<div class="result-elem-76">
								<img class="result-elem-77" src="./img/result-elem-77.png" alt="">
								<div class="result-elem-78">
									<div class="result-elem-79">Wavy</div>
									<div class="result-elem-80">얼굴 윤곽 분석 결과 웨이브 볼륨이 입체감을 줍니다.</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="result-elem-81" id="save-btn" role="button" tabindex="0">
				<div class="result-elem-82">저장하기</div>
			</div>
		</div>
	</div>
	<!-- 저장 시 보여줄 이미지 모달 -->
	<div id="saved-image-modal" class="saved-image-modal is-hidden" aria-hidden="true">
		<div class="saved-image-modal-backdrop"></div>
		<div class="saved-image-modal-content">
			<img id="saved-image-preview" src="" alt="저장된 결과">
			<button type="button" class="saved-image-modal-close" id="saved-image-close">닫기</button>
		</div>
	</div>
</body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script>
		// 피부 점수 랜덤 (전달값 없으면 62~95)
		var params = new URLSearchParams(location.search);
		var score = params.get('score');
		if (!score) score = 62 + Math.floor(Math.random() * 34);
		var el = document.getElementById('skin-score');
		if (el) el.textContent = score;

		// 브리핑 문구 랜덤
		var briefingOptions = [
			'컨디션은 좋지만 수분이 금방 빠져나가는 타입으로 보여요. 속부터 채우는 촉촉한 케어가 필요해요.<br/>피부 장벽과 탄력은 안정적이지만 수분 손실 지표가 다소 높습니다.',
			'피부 톤이 균일하고 탄력 지표가 양호해요. 유수분 밸런스를 유지하는 게 좋아요.<br/>자외선 차단과 수분 케어를 꾸준히 하시면 좋겠어요.',
			'전반적으로 안정적인 피부 상태예요. 색소 침착과 주름 지표가 양호합니다.<br/>지금의 루틴을 유지하시고, 수분 보충만 보강해 보세요.',
			'약간의 피로도가 보이지만 전반적으로 건강한 편이에요. 보습과 휴식을 충분히.<br/>저자극 제품으로 피부를 쉬게 해 주는 것도 도움이 됩니다.',
			'유수분 밸런스가 좋고 피부 장벽도 안정적이에요. 현재 컨디션을 유지하기 좋은 타입입니다.<br/>산화 스트레스 지표만 조금 신경 써 주시면 좋겠어요.'
		];
		var briefingEl = document.getElementById('result-briefing');
		if (briefingEl) briefingEl.innerHTML = briefingOptions[Math.floor(Math.random() * briefingOptions.length)];

		// 루틴 항목 랜덤 (5개 세트 중 하나)
		var routineSets = [
			['저자극 클렌징', '수분 토너 충분히 흡수', '히알루론산/판테놀 에센스', '보습크림으로 수분 잠금', '자외선 차단'],
			['오일 클렌징 후 저자극 세안', '세라마이드 토너', '비타민 C 세럼', '수분 크림', 'SPF 30+ 선크림'],
			['폼 클렌징', '알로에 토너', '나이아신아마이드 앰플', '수딩 크림', '재차단'],
			['더블 클렌징', '수분 팩 1주 2회', '레티놀 저농도 도입', '보습 밤', '자외선 차단 필수'],
			['젠틀 클렌징', '탄산 토너', '펩타이드 에센스', '세라마이드 크림', '광채 케어 선크림']
		];
		var routineSet = routineSets[Math.floor(Math.random() * routineSets.length)];
		var routineItems = document.querySelectorAll('#result-routine-list .result-elem-45, #result-routine-list .result-elem-49, #result-routine-list .result-elem-51, #result-routine-list .result-elem-53, #result-routine-list .result-elem-55');
		routineItems.forEach(function(item, i) { if (routineSet[i]) item.textContent = routineSet[i]; });

		// 오늘의 추천 스타일 문구 랜덤
		var styleTitles = [['Cheek', 'Peach', 'Cheek', 'Wavy'], ['Coral', 'Nude', 'Rose', 'Curly'], ['Pink', 'Beige', 'Brown', 'Volume']];
		var styleDescs = [
			['톤 대비 결과, 저채도 핑크가 가장 안정적입니다.', '채도 분석 결과, 저채도 피치가 가장 안정적입니다.', '눈동자 브라운 컬러가 자연스럽게 균형을 맞춥니다.', '얼굴 윤곽 분석 결과 웨이브 볼륨이 입체감을 줍니다.'],
			['피부톤과 잘 어울리는 코랄 포인트를 추천해요.', '네추럴한 누드 톤이 피부와 조화를 이룹니다.', '로즈 컬러가 혈색을 밝게 보이게 해요.', '컬 스타일이 얼굴형과 잘 맞습니다.'],
			['소프트 핑크가 피부 톤을 부드럽게 연출해요.', '베이지 계열이 자연스러운 인상을 줍니다.', '브라운 포인트가 눈매를 부각시킵니다.', '볼륨감이 얼굴 윤곽을 살려 줍니다.']
		];
		var styleIdx = Math.floor(Math.random() * styleTitles.length);
		var titles = styleTitles[styleIdx];
		var descs = styleDescs[styleIdx];
		var styleNames = document.querySelectorAll('.result-elem-64, .result-elem-69, .result-elem-74, .result-elem-79');
		var styleTexts = document.querySelectorAll('.result-elem-65, .result-elem-70, .result-elem-75, .result-elem-80');
		styleNames.forEach(function(el, i) { if (titles[i]) el.textContent = titles[i]; });
		styleTexts.forEach(function(el, i) { if (descs[i]) el.textContent = descs[i]; });
		// 스캔 시 캡처한 얼굴 이미지를 브리핑 썸네일(배경)에 표시 (캡처 시 찌그러짐 방지)
		try {
			var faceUrl = sessionStorage.getItem('faceCapture');
			var thumbWrap = document.getElementById('result-briefing-thumb');
			if (thumbWrap) {
				if (faceUrl) {
					thumbWrap.style.backgroundImage = 'url(' + faceUrl + ')';
					sessionStorage.removeItem('faceCapture');
				} else {
					thumbWrap.style.backgroundImage = 'url(./img/profile_image.png)';
				}
			}
		} catch (e) {}
		// 모달 안에서 열렸을 때 뒤로/엑스 버튼 누르면 모달만 닫고 카메라 화면으로
		if (window.self !== window.top) {
			function closeModal() {
				window.parent.postMessage('closeResultModal', '*');
			}
			var backBtn = document.getElementById('result-back');
			if (backBtn) backBtn.addEventListener('click', function(e) { e.preventDefault(); closeModal(); });
			var closeBtn = document.getElementById('result-close');
			if (closeBtn) closeBtn.addEventListener('click', closeModal);
		}
		// 저장하기 클릭 시 결과 화면 캡처해서 이미지로 표시
		var saveBtn = document.getElementById('save-btn');
		var savedModal = document.getElementById('saved-image-modal');
		var savedPreview = document.getElementById('saved-image-preview');
		var savedClose = document.getElementById('saved-image-close');
		var captureTarget = document.querySelector('.result-elem-3');
		if (saveBtn && captureTarget) {
			saveBtn.addEventListener('click', function() {
				var origTransform = captureTarget.style.transform || '';
				captureTarget.style.transform = 'none';
				window.scrollTo(0, 0);
				if (document.documentElement) document.documentElement.scrollTop = 0;
				if (document.body) document.body.scrollTop = 0;

				// 그래프가 애니메이션 최종 상태로 캡처되도록 강제 (opacity 0 → 1)
				var graphPath = document.querySelector('.result-elem-32');
				var graphPathOrigOpacity = '';
				var graphPathOrigTransform = '';
				var graphPathOrigAnimation = '';
				if (graphPath && graphPath.style) {
					graphPathOrigOpacity = graphPath.style.opacity || '';
					graphPathOrigTransform = graphPath.style.transform || '';
					graphPathOrigAnimation = graphPath.style.animation || '';
					graphPath.style.opacity = '1';
					graphPath.style.transform = 'scale(1)';
					graphPath.style.animation = 'none';
				}

				var fullW = 375;
				var fullH = Math.max(captureTarget.scrollHeight, 1581);
				var opts = {
					useCORS: true,
					allowTaint: true,
					scale: 2,
					backgroundColor: '#f2f2f7',
					width: fullW,
					height: fullH,
					scrollX: 0,
					scrollY: 0,
					x: 0,
					y: 0
				};
				html2canvas(captureTarget, opts).then(function(canvas) {
					var cropTop = 44;
					var w = canvas.width;
					var h = canvas.height;
					if (h > cropTop) {
						var cropped = document.createElement('canvas');
						cropped.width = w;
						cropped.height = h - cropTop;
						var ctx = cropped.getContext('2d');
						ctx.drawImage(canvas, 0, cropTop, w, h - cropTop, 0, 0, w, h - cropTop);
						canvas = cropped;
					}
					var dataUrl = canvas.toDataURL('image/png');
					var now = new Date();
					var y = now.getFullYear();
					var m = String(now.getMonth() + 1).padStart(2, '0');
					var d = String(now.getDate()).padStart(2, '0');
					var h = String(now.getHours()).padStart(2, '0');
					var min = String(now.getMinutes()).padStart(2, '0');
					var sec = String(now.getSeconds()).padStart(2, '0');
					var fileName = '피부진단_' + y + '-' + m + '-' + d + '_' + h + '-' + min + '-' + sec + '.png';
					var a = document.createElement('a');
					a.href = dataUrl;
					a.download = fileName;
					a.style.display = 'none';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
				}).catch(function(err) { console.warn('캡처 실패:', err); })
					.finally(function() {
						captureTarget.style.transform = origTransform;
						if (graphPath && graphPath.style) {
							graphPath.style.opacity = graphPathOrigOpacity;
							graphPath.style.transform = graphPathOrigTransform;
							graphPath.style.animation = graphPathOrigAnimation;
						}
					});
			});
			function closeSavedModal() {
				savedModal.classList.add('is-hidden');
				savedModal.setAttribute('aria-hidden', 'true');
			}
			if (savedClose) savedClose.addEventListener('click', closeSavedModal);
			savedModal.querySelector('.saved-image-modal-backdrop').addEventListener('click', closeSavedModal);
		}
	</script>
	<script src="https://pages.oss.navercorp.com/UIT/figma-sync/plugin/prod/core/resize.js"></script>
</html>
